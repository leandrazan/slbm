fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
params <- c("loc0" =25, "loc1" =0.3, "loc2" = 0.1,
"scale0" = 10, "shape" = 0.1 )
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
ny <- 100
pardat <- MDAdata(ny*90, locations = coords, margins = list(distr = "Pareto", shape = 0.1),
ms = list(kovmod = "whitmat", nugget = 0, range = 3, smooth = 0.44))
gev_struc
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 1, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 0.5, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
tcvrt <- temp_cvrt[ (115 - ny ):115 , ]$smoothed_GMST
cvrt_sl <- c(rep(tcvrt[1], 45), rep(tcvrt[2:(ny)], each = 90))
cvrt_sl <- c(cvrt_sl, rep(tcvrt[ny +1], ny*90 - length(cvrt_sl) ))
xx1 <- cbind(xx, cvrt_sl)
yy1 <- data.frame(xx1) %>% pivot_longer( 1:10, names_to = "Station", values_to = "Obs")
yy1
get_uniq_bm(yy1, blcksz = 90)
yy <- data.frame(xx) %>% pivot_longer( 1:10, names_to = "Station", values_to = "Obs")
yyuniq <- get_uniq_bm(yy, blcksz = 90)
yyuniq %>% unnest(cols = uniq_data)
params <- c("loc0" =25, "loc1" =0.3, "loc2" = 0.1,
"scale0" = 10, "shape" = 0.1 )
yy
yyuniq
bms <- yyuniq
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
bms
prep4spatml
yy1
get_uniq_bm(yy1, blcksz = 90)
xx1
yy1
yy
length(cvrt_sl)
bms <- get_uniq_bm(xx, 90, cvrt_sl[1:nrow(xx)])
get_uniq_bm
yy
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:nrow(xx)])
bms <- get_uniq_bm(yy, 90, cvrt_sl)
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:nrow(yy)])
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:8911])
bms
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
log(1.5)
params <- c("loc0" =25, "loc1" =0.3, "loc2" = 0.1, "loc3" = 0,
"scale0" = 0.5, "shape" = 0.1 )
#lon = 0.4, lat = 0.3, alt = -0.05,
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + lat + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
exp(-1.218)
params <- c("loc0" = 20, "loc1" = 0.3, "loc2" = 0.1, "loc3" = 0,
"scale0" = 0.5, "shape" = 0.1 )
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:8911])
#lon = 0.4, lat = 0.3, alt = -0.05,
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + lat + ele, scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
nll_spat_temp_sl_prep <- function(params, loc.sp.form, scale.sp.form,
loc.temp.form = NULL, scale.temp.form = NULL,
dataprep, spat.cov, hom = FALSE ){
params.sp <- list(loc = params[startsWith(names(params),"loc")],
scale = params[startsWith(names(params),"scale")],
shape = params[startsWith(names(params),"shape")])
params.temp <- list(loc = params[startsWith(names(params),"tempLoc")],
scale = params[startsWith(names(params),"tempScale")])
params.temp <- purrr::map(params.temp, function(.x) ifelse(length(.x) == 0, 0, .x) )
model.loc.sp <- dataprep$MatLocSp
model.scale.sp <- dataprep$MatScaleSp
dataprep <- dataprep$data
if(!is.null(loc.temp.form)) {
loc.temp.form <- update(loc.temp.form,  ~ . + 0)
dataprep <- dataprep %>%
dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatLocTemp, function(.x, .y){
loc_param_temp <- as.numeric(.y %*% params.temp$loc)
.x %>% dplyr::bind_cols(loc_temp = loc_param_temp)
}
)) %>%
dplyr::select( - MatLocTemp)
}
if(!is.null(scale.temp.form)) {
scale.temp.form <- update(scale.temp.form,  ~ . + 0)
dataprep <- dataprep %>%
dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatScaleTemp, function(.x, .y){
scale_param_temp <- .y %*% params.temp$scale
.x %>% dplyr::bind_cols(scale_temp = scale_param_temp)
}
)) %>%
dplyr::select( - MatScaleTemp)
}
loc_sp <- data.frame(loc_sp = model.loc.sp %*% params.sp$loc)
scale_sp <-  data.frame(scale_sp = model.scale.sp %*% params.sp$scale)
dataprep <- dataprep %>% dplyr::bind_cols( loc_sp , scale_sp )
dataprep <-  dataprep %>%
dplyr::mutate( nllh_val = purrr::pmap(list(.ud = uniq_data, .locsp = loc_sp,
.scalesp = scale_sp, .shape = params.sp$shape),
.f = function(.ud, .locsp, .scalesp, .shape) {
tempcv <- colnames(.ud)
.loc_temp <- ifelse( "loc_temp" %in% tempcv,
.ud$loc_temp, 0)
.scale_temp <- ifelse( "scale_temp" %in% tempcv,
.ud$scale_temp, 0)
log_dens(obs = .ud$slbm, weight = .ud$n,
loc_temp = .loc_temp,
loc_sp = .locsp,
scale_temp = .scale_temp,
scale_sp = .scalesp,
shape = .shape)
} ) )
sum(unlist(dataprep$nllh_val))
}
xx
nll_spat(params, loc.sp.form = ~ lon + ele, scale.sp.form = ~ lon,
data =  apply(xx, 2, blockmax, r = 90, "sliding"),
spat.cov = spatial_cvrt )
fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"), loc.sp.form = ~ lon + ele, scale.sp.form = ~ lon,
spat.cov = spatial_cvrt)
warnings()
fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"), loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
spat.cov = spatial_cvrt)
system.time({
fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"), loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
spat.cov = spatial_cvrt)
})
params <- c("loc0" = 27.41605184, "loc1"=  0.70058967, "loc2"=  -0.03781526,
"scale0" = -1.21880075  , "shape"= 0.04022921 )
#lon = 0.4, lat = 0.3, alt = -0.05,
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
system.time({
fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
system.time({
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"), loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
spat.cov = spatial_cvrt)
})
estim1
estim2
coords4
coords
x <- y <- seq(0, 50, length = 50)
spatial_cvrt <- data.frame(lat  = x, lon = y, ele = runif(50))
pardat <- MDAdata(ny*90, locations = coords, margins = list(distr = "Pareto", shape = 0.1),
ms = list(kovmod = "whitmat", nugget = 0, range = 3, smooth = 0.44))
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 0.5, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
coords <- cbind(spatial_cvrt$lat, spatial_cvrt$lon)
colnames(coords ) <- c("lat", "lon")
dstat <- 50
x <- y <- seq(0, dstat, length = dstat)
spatial_cvrt <- data.frame(lat  = x, lon = y, ele = runif(dstat))
### smoothed GMST anomaly covariate
temp_cvrt <- BMRLest::Covariate
temp_cvrt
coords <- cbind(spatial_cvrt$lat, spatial_cvrt$lon)
colnames(coords ) <- c("lat", "lon")
pardat <- MDAdata(ny*90, locations = coords, margins = list(distr = "Pareto", shape = 0.1),
ms = list(kovmod = "whitmat", nugget = 0, range = 3, smooth = 0.44))
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 0.5, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
tcvrt <- temp_cvrt[ (115 - ny ):115 , ]$smoothed_GMST
cvrt_sl <- c(rep(tcvrt[1], 45), rep(tcvrt[2:(ny)], each = 90))
cvrt_sl <- c(cvrt_sl, rep(tcvrt[ny +1], ny*90 - length(cvrt_sl) ))
yy <- data.frame(xx) %>% pivot_longer( 1:10, names_to = "Station", values_to = "Obs")
yy
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:8911])
bms
yy
yy <- data.frame(xx) %>% pivot_longer( 1:ddat, names_to = "Station", values_to = "Obs")
yy <- data.frame(xx) %>% pivot_longer( 1:dstat, names_to = "Station", values_to = "Obs")
yy
dstat
yy <- data.frame(xx) %>% pivot_longer( 1:50, names_to = "Station", values_to = "Obs")
yy %>% tail()
yyuniq <- get_uniq_bm(yy, blcksz = 90)
yyuniq %>% unnest(cols = uniq_data)
yyuniq
bms <- get_uniq_bm(yy, 90, cvrt_sl[1:8911])
bms
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = NULL, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
estim1
system.time({
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"), loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
spat.cov = spatial_cvrt)
})
estim2
estim1
fit_spgev
plot.ts(xx[, 1])
lines(xx[, 2], col = 2)
cvrt_sl
nrow(cvrt_sl)
length(cvrt_sl)
nrow(xx)
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"),
loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
spat.cov = spatial_cvrt, temp.cov = data.frame(GMST = cvrt_sl[1: (nrow(xx) - 90 +1)])
})
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"),
loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
spat.cov = spatial_cvrt, temp.cov = data.frame(GMST = cvrt_sl[1: (nrow(xx) - 90 +1)]))
estim2
system.time({
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = 90, "sliding"),
loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
spat.cov = spatial_cvrt, temp.cov = data.frame(GMST = cvrt_sl[1: (nrow(xx) - 90 +1)]))
})
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
params <- c("loc0" = 27.41605184, "loc1"=  0.70058967, "loc2"=  -0.03781526, "locTemp" = 0,
"scale0" = -1.21880075  , "shape"= 0.04022921 )
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
params <- c("loc0" = 27.41605184, "loc1"=  0.70058967, "loc2"=  -0.03781526, "tempLoc" = 0,
"scale0" = -1.21880075  , "shape"= 0.04022921 )
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
estim1
estim2
ny <- 100
dstat <- 30
x <- y <- seq(0, dstat, length = dstat)
spatial_cvrt <- data.frame(lat  = x, lon = y, ele = runif(dstat))
### smoothed GMST anomaly covariate
temp_cvrt <- BMRLest::Covariate
temp_cvrt
coords <- cbind(spatial_cvrt$lat, spatial_cvrt$lon)
colnames(coords ) <- c("lat", "lon")
blcksz <- 1000
pardat <- MDAdata(ny*blcksz, locations = coords, margins = list(distr = "Pareto", shape = 0.1),
ms = list(kovmod = "whitmat", nugget = 0, range = 3, smooth = 0.44))
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 0.5, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
tcvrt <- temp_cvrt[ (115 - ny ):115 , ]$smoothed_GMST
cvrt_sl <- c(rep(tcvrt[1], blcksz/2), rep(tcvrt[2:(ny)], each = blcksz))
cvrt_sl <- c(cvrt_sl, rep(tcvrt[ny +1], ny*blcksz - length(cvrt_sl) ))
yy <- data.frame(xx) %>% pivot_longer( 1:dstat, names_to = "Station", values_to = "Obs")
yy
system.time({
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = blcksz, "sliding"),
loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
spat.cov = spatial_cvrt, temp.cov = data.frame(GMST = cvrt_sl[1: (nrow(xx) - blcksz +1)]))
})
blcksz <- 365
pardat <- MDAdata(ny*blcksz, locations = coords, margins = list(distr = "Pareto", shape = 0.1),
ms = list(kovmod = "whitmat", nugget = 0, range = 3, smooth = 0.44))
xx <- gev_struc(pardat, n.years = ny, covariates = list(spatial = spatial_cvrt,
temporal = temp_cvrt),
spatial.pars = list(loc = list( lon = 0.4, lat = 0.3, alt = -0.05, lon2= 0, lat2 = 0, alt2= 0),
scale = list()),
temp.pars = list(loc = list( GMST  = 0.5, time = 0),
scale = list()),
determ.pars = list(loc = 25, scale = 1.5))
tcvrt <- temp_cvrt[ (115 - ny ):115 , ]$smoothed_GMST
cvrt_sl <- c(rep(tcvrt[1], blcksz/2), rep(tcvrt[2:(ny)], each = blcksz))
cvrt_sl <- c(cvrt_sl, rep(tcvrt[ny +1], ny*blcksz - length(cvrt_sl) ))
yy <- data.frame(xx) %>% pivot_longer( 1:dstat, names_to = "Station", values_to = "Obs")
system.time({
estim2 <- fit_spgev( apply(xx, 2, blockmax, r = blcksz, "sliding"),
loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
spat.cov = spatial_cvrt, temp.cov = data.frame(GMST = cvrt_sl[1: (nrow(xx) - blcksz +1)]))
})
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
params <- c("loc0" = 27.41605184, "loc1"=  0.70058967, "loc2"=  -0.03781526, "tempLoc" = 0,
"scale0" = -1.21880075  , "shape"= 0.04022921 )
bms <- get_uniq_bm(yy, blcksz, cvrt_sl[1: (nrow(xx) - blcksz +1) ])
system.time({
estim1 <- fit_spgev_sl(data = bms, loc.sp.form = ~ lon + ele ,  scale.sp.form = ~ 1,
loc.temp.form = ~ GMST, scale.temp.form = NULL,
spat.cov = spatial_cvrt, start_vals = params, use_gr = FALSE,
method = "Nelder-Mead", st_val_meth = "LeastSq", print_start_vals = TRUE)
})
nll_spat_temp_sl_prep <- function(params, loc.sp.form, scale.sp.form,
loc.temp.form = NULL, scale.temp.form = NULL,
dataprep, spat.cov, hom = FALSE ){
params.sp <- list(loc = params[startsWith(names(params),"loc")],
scale = params[startsWith(names(params),"scale")],
shape = params[startsWith(names(params),"shape")])
params.temp <- list(loc = params[startsWith(names(params),"tempLoc")],
scale = params[startsWith(names(params),"tempScale")])
params.temp <- purrr::map(params.temp, function(.x) ifelse(length(.x) == 0, 0, .x) )
model.loc.sp <- dataprep$MatLocSp
model.scale.sp <- dataprep$MatScaleSp
dataprep <- dataprep$data
if(!is.null(loc.temp.form)) {
loc.temp.form <- update(loc.temp.form,  ~ . + 0)
browser()
dataprep <- dataprep %>%
dplyr::mutate(LocTemp =  purrr::map2(MatLocTemp,
~ as.numeric( .x %*% params.temp$loc) )
) %>%
dplyr::select( - MatLocTemp)
}
#   dataprep <- dataprep %>%
#     dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatLocTemp, function(.x, .y){
#       loc_param_temp <- as.numeric(.y %*% params.temp$loc)
#
#       .x %>% dplyr::bind_cols(loc_temp = loc_param_temp)
#
#     }
#     )) %>%
#     dplyr::select( - MatLocTemp)
#
# }
if(!is.null(scale.temp.form)) {
scale.temp.form <- update(scale.temp.form,  ~ . + 0)
dataprep <- dataprep %>%
dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatScaleTemp, function(.x, .y){
scale_param_temp <- .y %*% params.temp$scale
.x %>% dplyr::bind_cols(scale_temp = scale_param_temp)
}
)) %>%
dplyr::select( - MatScaleTemp)
}
loc_sp <- data.frame(loc_sp = model.loc.sp %*% params.sp$loc)
scale_sp <-  data.frame(scale_sp = model.scale.sp %*% params.sp$scale)
dataprep <- dataprep %>% dplyr::bind_cols( loc_sp , scale_sp )
dataprep <-  dataprep %>%
dplyr::mutate( nllh_val = purrr::pmap(list(.ud = uniq_data, .locsp = loc_sp,
.scalesp = scale_sp, .shape = params.sp$shape),
.f = function(.ud, .locsp, .scalesp, .shape) {
tempcv <- colnames(.ud)
.loc_temp <- ifelse( "loc_temp" %in% tempcv,
.ud$loc_temp, 0)
.scale_temp <- ifelse( "scale_temp" %in% tempcv,
.ud$scale_temp, 0)
log_dens(obs = .ud$slbm, weight = .ud$n,
loc_temp = .loc_temp,
loc_sp = .locsp,
scale_temp = .scale_temp,
scale_sp = .scalesp,
shape = .shape)
} ) )
sum(unlist(dataprep$nllh_val))
}
nll_spat_temp_sl(params, loc.sp.form = ~ lon + lat +  ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
data =  bms,
spat.cov = spatial_cvrt)
bms
params
nll_spat_sl(params, loc.sp.form = ~ lon + ele, scale.sp.form = ~ 1,
data =  yyuniq,
spat.cov = spatial_cvrt)
nll_spat_temp_sl(params, loc.sp.form = ~ lon +  ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
data =  bms,
spat.cov = spatial_cvrt)
nll_spat_temp_sl(params, loc.sp.form = ~ lon +  ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
dataprep  =  prep4spatml( loc.sp.form =  ~ lon + ele, scale.sp.form = ~1, loc.temp.form = ~GMST, data = bms, spat.cov = spatial_cvrt ),
spat.cov = spatial_cvrt)
nll_spat_temp_sl_prep <- function(params, loc.sp.form, scale.sp.form,
loc.temp.form = NULL, scale.temp.form = NULL,
dataprep, spat.cov, hom = FALSE ){
params.sp <- list(loc = params[startsWith(names(params),"loc")],
scale = params[startsWith(names(params),"scale")],
shape = params[startsWith(names(params),"shape")])
params.temp <- list(loc = params[startsWith(names(params),"tempLoc")],
scale = params[startsWith(names(params),"tempScale")])
params.temp <- purrr::map(params.temp, function(.x) ifelse(length(.x) == 0, 0, .x) )
model.loc.sp <- dataprep$MatLocSp
model.scale.sp <- dataprep$MatScaleSp
dataprep <- dataprep$data
if(!is.null(loc.temp.form)) {
loc.temp.form <- update(loc.temp.form,  ~ . + 0)
browser()
dataprep <- dataprep %>%
dplyr::mutate(LocTemp =  purrr::map2(MatLocTemp,
~ as.numeric( .x %*% params.temp$loc) )
) %>%
dplyr::select( - MatLocTemp)
}
#   dataprep <- dataprep %>%
#     dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatLocTemp, function(.x, .y){
#       loc_param_temp <- as.numeric(.y %*% params.temp$loc)
#
#       .x %>% dplyr::bind_cols(loc_temp = loc_param_temp)
#
#     }
#     )) %>%
#     dplyr::select( - MatLocTemp)
#
# }
if(!is.null(scale.temp.form)) {
scale.temp.form <- update(scale.temp.form,  ~ . + 0)
dataprep <- dataprep %>%
dplyr::mutate(uniq_data =  purrr::map2(.x = uniq_data, .y = MatScaleTemp, function(.x, .y){
scale_param_temp <- .y %*% params.temp$scale
.x %>% dplyr::bind_cols(scale_temp = scale_param_temp)
}
)) %>%
dplyr::select( - MatScaleTemp)
}
loc_sp <- data.frame(loc_sp = model.loc.sp %*% params.sp$loc)
scale_sp <-  data.frame(scale_sp = model.scale.sp %*% params.sp$scale)
dataprep <- dataprep %>% dplyr::bind_cols( loc_sp , scale_sp )
dataprep <-  dataprep %>%
dplyr::mutate( nllh_val = purrr::pmap(list(.ud = uniq_data, .locsp = loc_sp,
.scalesp = scale_sp, .shape = params.sp$shape),
.f = function(.ud, .locsp, .scalesp, .shape) {
tempcv <- colnames(.ud)
.loc_temp <- ifelse( "loc_temp" %in% tempcv,
.ud$loc_temp, 0)
.scale_temp <- ifelse( "scale_temp" %in% tempcv,
.ud$scale_temp, 0)
log_dens(obs = .ud$slbm, weight = .ud$n,
loc_temp = .loc_temp,
loc_sp = .locsp,
scale_temp = .scale_temp,
scale_sp = .scalesp,
shape = .shape)
} ) )
sum(unlist(dataprep$nllh_val))
}
nll_spat_temp_sl_prep(params, loc.sp.form = ~ lon +  ele, scale.sp.form = ~ 1,
loc.temp.form = ~ GMST,
dataprep  =  prep4spatml( loc.sp.form =  ~ lon + ele, scale.sp.form = ~1, loc.temp.form = ~GMST, data = bms, spat.cov = spatial_cvrt ),
spat.cov = spatial_cvrt)
dataprep
dataprep %>%
dplyr::mutate(LocTemp =  purrr::map2(MatLocTemp,
~ as.numeric( .x %*% params.temp$loc) )
)
dataprep %>%
dplyr::mutate(LocTemp =  purrr::map(MatLocTemp,
~ as.numeric( .x %*% params.temp$loc) )
)
params.temp$loc

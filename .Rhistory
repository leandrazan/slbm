cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995),
mult_sc = TRUE)
concbm
dur
concbm$newslbm
cv_res
#' example_data <- data.frame(datetime = dates, prec = prec)
#'
#' agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
#' agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
#' concbm <- compute_conc_bm_id(agdf)
#' cvres <- fit_dgev_cv_qs(agbm, concbm,  ds = c(1,4,8, 24))
#' # compute mean quantile scores based on cross-validation:
#' cvres %>% dplyr::select( - c( mut, sigma0, shape, eta, conv, Testdata )) %>%
#'           dplyr::group_by(ds, ps, estimator) %>%
#'           dplyr::summarise(MQS = mean(quant_score), .groups = "drop")
fit_dgev_cv_qs <- function(agg_bm, conc_bm, ds,
quants =  1-1/c(50, 100 ), mult_sc = FALSE,
dur_offset = FALSE, int_offset = FALSE, testset = "consec",
n.lo = 3, n.cv = NULL, method = "both", returnLO = FALSE,
optimMethod = "Nelder-Mead", Maxit = 1500, ... ){
years_obs <- agg_bm[1, ]$djbm[[1]]$Year
n.years <- length(years_obs)
if(testset == "consec") {
cvstart <- seq(years_obs[1], years_obs[n.years], n.lo)
sbst <- purrr::map(cvstart, ~ .x + (0:(n.lo -1)))
sbst[[length(sbst)]] <-  sbst[[length(sbst)]][ sbst[[length(sbst)]] <= years_obs[n.years]]
n.cv <- length(sbst)
} else if( testset == "random") {
assertthat::assert_that(is.numeric(n.cv))
all.subsets <- combn(years_obs, n.lo, simplify = F)
sbst <- sample(all.subsets, min(n.cv, nrow(all.subsets)) )
n.cv <- length(sbst)
} else {
stop("This is not a valid method to construct the test set. Choose either 'consec' or 'random'")
}
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  ds,
quants = quants, mult_sc = mult_sc, dur_offset = dur_offset,
int_offset = int_offset, optimMethod = optimMethod, Maxit = Maxit, ... )  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
if(!returnLO){
tibres <-   tibres %>% dplyr::select(-left_out)
}
if(!(method == "both")){
tibres <- tibres %>%
dplyr::mutate( Result = purrr::map(Result, ~ .x %>% dplyr::filter( estimator == method)))
}
tibres %>% tidyr::unnest(cols = Result)
}
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
cv_res
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995), mu
lt_scale = TRUE)
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995))
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995))
cv_res
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995), returnLO = TRUE)
cv_res
cv_res[1, ]$left_out
cv_res %>% tail()
cv_res[590, ]
cv_res[590, ]$left_out
leave_out <- 2020
agg_bm
agg_bm_test <- agg_bm %>% dplyr::select(djbm) %>%
tidyr::unnest(cols = djbm) %>% dplyr::filter(Year %in% leave_out)
dj_train <- agg_bm %>% dplyr::select(-slbm) %>%
dplyr::mutate(djbm = purrr::map(djbm, ~ .x %>% dplyr::filter(!(Year %in% leave_out))))
minmaxn <- do.call( function(.x){data.frame(Min = min(.x), Max = max(.x),
Nobs = length(.x))} , list(agg_bm[1,]$djbm[[1]]$Year))
minmaxn
sl_lo <- data.frame(year1 = leave_out, year2 = leave_out -1)
sl_lo <- sl_lo %>% dplyr::mutate(year2 = ifelse(year2 >= minmaxn$Min, year2, year2 + minmaxn$Nobs))
sl_train1 <- agg_bm %>% dplyr::select( - djbm) %>%
dplyr::mutate(slbm = purrr::map(slbm, ~ .x %>% dplyr::filter(!(Year %in% unlist(sl_lo)))))
conc_bm <- conc_bm %>% dplyr::filter(ind1 %in% sl_lo$year2)  ## filter for possible new starting years
conc_bm
concbm
conc_bm <- concbm
conc_bm <- conc_bm %>% dplyr::filter(ind1 %in% sl_lo$year2)  ## filter for possible new starting years
conc_bm
sl_train1
sl_lo
newsample <- sl_train1
agg_bm <- dplyr::right_join(dj_train, newsample, by = "duration")
agg_bm
gev.d.fit.sl(agg_bm = agg_bm
)
dgev_cv_fit(agg_bm, concbm, leave_out = 2020, ds = dur, quants = .99)
agg_bm
concbm
25/3
sbst
sbst
map(sbst, ~ lenght(.x))
map(sbst, ~ length(.x))
map(sbst, ~ length(.x)) == 3
sbst[[map(sbst, ~ length(.x)) == 3]]
sbst[map(sbst, ~ length(.x)) == 3]
cvstart <- seq(years_obs[1], years_obs[n.years], n.lo)
sbst <- purrr::map(cvstart, ~ .x + (0:(n.lo -1)))
sbst[[length(sbst)]] <-  sbst[[length(sbst)]][ sbst[[length(sbst)]] <= years_obs[n.years]]
sbst <- sbst[map(sbst, ~ length(.x)) == n.lo]
sbst
agg_bm
agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
dates <- seq(as.POSIXct("2000-01-01 00:00:00"),
as.POSIXct("2020-12-31 23:00:00"),by = 'hour')
prec <- rgamma(length(dates), shape = 0.1)
example_data <- data.frame(datetime = dates, prec = prec)
agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
concbm <- compute_conc_bm_id(agdf, nlo = 3, testset = "consec")
dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2003, 2004, 2005),
quants = c(.5, .9, .99) )
dates <- seq(as.POSIXct("2000-01-01 00:00:00"),
as.POSIXct("2020-12-31 23:00:00"),by = 'hour')
prec <- rgamma(length(dates), shape = 0.1)
example_data <- data.frame(datetime = dates, prec = prec)
agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
concbm <- compute_conc_bm_id(agdf, testset = "consec")
cvres <- fit_dgev_cv_qs(agbm, concbm,  ds = c(1,4,8, 24))
cvres
cvres <- fit_dgev_cv_qs(agbm, concbm,  ds = c(1,4,8, 24), returnLO = TRUE)
cvres
cvres[1,]$left_out
cvres[590,]$left_out
cvres[590, ]
agg_bm <- agbm
conc_bm <- concbm
years_obs <- agg_bm[1, ]$djbm[[1]]$Year
n.years <- length(years_obs)
cvstart <- seq(years_obs[1], years_obs[n.years], n.lo)
sbst <- purrr::map(cvstart, ~ .x + (0:(n.lo -1)))
sbst[[length(sbst)]] <-  sbst[[length(sbst)]][ sbst[[length(sbst)]] <= years_obs[n.years]]
sbst <- sbst[map(sbst, ~ length(.x)) == n.lo]
n.lo
sbst
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  ds,
quants = quants, mult_sc = mult_sc, dur_offset = dur_offset,
int_offset = int_offset, optimMethod = optimMethod, Maxit = Maxit, ... )  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  dur,
quants = .99,)  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  dur,
quants = .99)  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres
tibres[1, ]$Result
tibres[1, ]$left_out
tibres[7, ]$left_out
dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2000, 2001, 2002),
#'  quants = c(.5, .9, .99) )
quants = c(.5, .9, .99) )
agg_bm_test <- agg_bm %>% dplyr::select(djbm) %>%
tidyr::unnest(cols = djbm) %>% dplyr::filter(Year %in% leave_out)
leave_out <- 2000:2002
agg_bm_test <- agg_bm %>% dplyr::select(djbm) %>%
tidyr::unnest(cols = djbm) %>% dplyr::filter(Year %in% leave_out)
dj_train <- agg_bm %>% dplyr::select(-slbm) %>%
dplyr::mutate(djbm = purrr::map(djbm, ~ .x %>% dplyr::filter(!(Year %in% leave_out))))
minmaxn <- do.call( function(.x){data.frame(Min = min(.x), Max = max(.x),
Nobs = length(.x))} , list(agg_bm[1,]$djbm[[1]]$Year))
sl_lo <- data.frame(year1 = leave_out, year2 = leave_out -1)
sl_lo <- sl_lo %>% dplyr::mutate(year2 = ifelse(year2 >= minmaxn$Min, year2, year2 + minmaxn$Nobs))
sl_train1 <- agg_bm %>% dplyr::select( - djbm) %>%
dplyr::mutate(slbm = purrr::map(slbm, ~ .x %>% dplyr::filter(!(Year %in% unlist(sl_lo)))))
conc_bm <- conc_bm %>% dplyr::filter(ind1 %in% sl_lo$year2)  ## filter for possible new starting years
conc_bm
purrr::is_empty(conc_bm)
conc_bm
conc_bm$ind1
conc_bm$ind1 %>% is.numeric()
conc_bm$ind1 %>% is.null()
conc_bm$ind1 %>% is_empty()
nrow(conc_bm)
# neither the new starting year nor the following year can be in the new sliding block
if(nrow(conc_bm)){
newsample <- sl_train1
} else {
conc_bm <- conc_bm %>%
dplyr::filter(!(ind1 %in% leave_out) ) %>%
dplyr::filter(!(ind2 %in% leave_out))
conc_bm <- conc_bm %>% dplyr::mutate(Diff = ind2 - ind1) %>%
dplyr::mutate(Diff = ifelse(Diff >= 0, Diff, Diff + minmaxn$Nobs)) %>%
dplyr::group_by(ind1) %>%
dplyr::filter(Diff == min(Diff)) %>%
dplyr::ungroup() %>%
dplyr::select(-Diff)
conc_bm <- conc_bm %>% tidyr::unnest(cols = newslbm) %>%
dplyr::select(-c( ind2)) %>%
tidyr::unnest(cols = conc_slbm) %>%
dplyr::group_by(duration) %>%
tidyr::nest(cols = c( ind1 , conc_slbm))  %>% dplyr::ungroup()
newsample <- conc_bm %>% dplyr::left_join(sl_train1, by = "duration") %>%
dplyr::mutate(slbm = purrr::map2(.x = cols, .y = slbm , function(.x, .y){
.x <- dplyr::rename(.x, "Year" = ind1, "sldata" = conc_slbm)
dplyr::bind_rows(.x, .y)
})) %>% dplyr::select(-cols)
}
nrow(conc_bm)
# neither the new starting year nor the following year can be in the new sliding block
if(nrow(conc_bm) == 0){
newsample <- sl_train1
} else {
conc_bm <- conc_bm %>%
dplyr::filter(!(ind1 %in% leave_out) ) %>%
dplyr::filter(!(ind2 %in% leave_out))
conc_bm <- conc_bm %>% dplyr::mutate(Diff = ind2 - ind1) %>%
dplyr::mutate(Diff = ifelse(Diff >= 0, Diff, Diff + minmaxn$Nobs)) %>%
dplyr::group_by(ind1) %>%
dplyr::filter(Diff == min(Diff)) %>%
dplyr::ungroup() %>%
dplyr::select(-Diff)
conc_bm <- conc_bm %>% tidyr::unnest(cols = newslbm) %>%
dplyr::select(-c( ind2)) %>%
tidyr::unnest(cols = conc_slbm) %>%
dplyr::group_by(duration) %>%
tidyr::nest(cols = c( ind1 , conc_slbm))  %>% dplyr::ungroup()
newsample <- conc_bm %>% dplyr::left_join(sl_train1, by = "duration") %>%
dplyr::mutate(slbm = purrr::map2(.x = cols, .y = slbm , function(.x, .y){
.x <- dplyr::rename(.x, "Year" = ind1, "sldata" = conc_slbm)
dplyr::bind_rows(.x, .y)
})) %>% dplyr::select(-cols)
}
agg_bm <- dplyr::right_join(dj_train, newsample, by = "duration")
fitb <- gev.d.fit.sl(agg_bm = agg_bm, mult_sc = mult_sc,
dur_offset = dur_offset, int_offset = int_offset,
optimMethod = optimMethod,
Maxit = Maxit, ...)
mlest <- dplyr::bind_cols(fitb$mle, conv =  fitb$conv)
rmcol <- character()
if(!mult_sc) {
mlest <- mlest %>% dplyr::bind_cols( eta2 = 0)
rmcol <- c( rmcol, "eta2")
}
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  ds,
quants = quants, mult_sc = mult_sc, dur_offset = dur_offset,
int_offset = int_offset, optimMethod = optimMethod, Maxit = Maxit, ... )  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  dur)  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  dur,
quants = .99)  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres
dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2003, 2004, 2005),
quants = c(.5, .9, .99) )
#' as.POSIXct("2020-12-31 23:00:00"),by = 'hour')
#' prec <- rgamma(length(dates), shape = 0.1)
#' example_data <- data.frame(datetime = dates, prec = prec)
#'
#' agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
#' agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
#' concbm <- compute_conc_bm_id(agdf, nlo = 3, testset = "consec")
#' dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2003, 2004, 2005),
#'  quants = c(.5, .9, .99) )
#'
dgev_cv_fit <- function(agg_bm, conc_bm, leave_out , ds, quants, mult_sc = FALSE,  dur_offset = FALSE,
int_offset = FALSE, optimMethod = "Nelder-Mead", Maxit = 1500, ...){
agg_bm_test <- agg_bm %>% dplyr::select(djbm) %>%
tidyr::unnest(cols = djbm) %>% dplyr::filter(Year %in% leave_out)
dj_train <- agg_bm %>% dplyr::select(-slbm) %>%
dplyr::mutate(djbm = purrr::map(djbm, ~ .x %>% dplyr::filter(!(Year %in% leave_out))))
minmaxn <- do.call( function(.x){data.frame(Min = min(.x), Max = max(.x),
Nobs = length(.x))} , list(agg_bm[1,]$djbm[[1]]$Year))
sl_lo <- data.frame(year1 = leave_out, year2 = leave_out -1)
sl_lo <- sl_lo %>% dplyr::mutate(year2 = ifelse(year2 >= minmaxn$Min, year2, year2 + minmaxn$Nobs))
sl_train1 <- agg_bm %>% dplyr::select( - djbm) %>%
dplyr::mutate(slbm = purrr::map(slbm, ~ .x %>% dplyr::filter(!(Year %in% unlist(sl_lo)))))
conc_bm <- conc_bm %>% dplyr::filter(ind1 %in% sl_lo$year2)  ## filter for possible new starting years
# neither the new starting year nor the following year can be in the new sliding block
if(nrow(conc_bm) == 0){
newsample <- sl_train1
} else {
conc_bm <- conc_bm %>%
dplyr::filter(!(ind1 %in% leave_out) ) %>%
dplyr::filter(!(ind2 %in% leave_out))
conc_bm <- conc_bm %>% dplyr::mutate(Diff = ind2 - ind1) %>%
dplyr::mutate(Diff = ifelse(Diff >= 0, Diff, Diff + minmaxn$Nobs)) %>%
dplyr::group_by(ind1) %>%
dplyr::filter(Diff == min(Diff)) %>%
dplyr::ungroup() %>%
dplyr::select(-Diff)
conc_bm <- conc_bm %>% tidyr::unnest(cols = newslbm) %>%
dplyr::select(-c( ind2)) %>%
tidyr::unnest(cols = conc_slbm) %>%
dplyr::group_by(duration) %>%
tidyr::nest(cols = c( ind1 , conc_slbm))  %>% dplyr::ungroup()
newsample <- conc_bm %>% dplyr::left_join(sl_train1, by = "duration") %>%
dplyr::mutate(slbm = purrr::map2(.x = cols, .y = slbm , function(.x, .y){
.x <- dplyr::rename(.x, "Year" = ind1, "sldata" = conc_slbm)
dplyr::bind_rows(.x, .y)
})) %>% dplyr::select(-cols)
}
agg_bm <- dplyr::right_join(dj_train, newsample, by = "duration")
fitb <- gev.d.fit.sl(agg_bm = agg_bm, mult_sc = mult_sc,
dur_offset = dur_offset, int_offset = int_offset,
optimMethod = optimMethod,
Maxit = Maxit, ...)
mlest <- dplyr::bind_cols(fitb$mle, conv =  fitb$conv)
rmcol <- character()
if(!mult_sc) {
mlest <- mlest %>% dplyr::bind_cols( eta2 = 0)
rmcol <- c( rmcol, "eta2")
}
if(!int_offset) {
mlest <- mlest %>% dplyr::bind_cols( tau = 0)
rmcol <- c(rmcol, "tau")
}
if(!dur_offset) {
mlest <- mlest %>% dplyr::bind_cols( theta = 0)
rmcol <- c(rmcol, "theta")
}
table_quants <- mlest %>% tidyr::expand_grid(ps = quants,
ds = ds)
table_quants <- table_quants %>%
dplyr::mutate( est.quants = purrr::pmap_dbl( list(mut, sigma0, shape, theta,  eta, eta2, tau, ps, ds) ,
.f = function( .mut, .sigma0, .shape, .theta,
.eta, .eta2, .tau, .ps, .d){
IDF::qgev.d(.ps, mut = .mut, sigma0 = .sigma0, xi = .shape ,
eta = .eta , eta2 = (.eta2 + .eta), tau = .tau ,
theta = .theta, d = .d)
}
))
table_quants <- table_quants[ , !(colnames(table_quants) %in% rmcol)]
zns  <- agg_bm_test %>%
dplyr::select(-Year)
zns <- dplyr::rename(zns, "ds"= "duration")
zns <- zns %>% dplyr::group_by(ds) %>% tidyr::nest(Testdata = djdata)
table_quants <- dplyr::left_join(table_quants, zns, by = "ds")
table_quants <- table_quants %>%
dplyr::mutate( quant_score = purrr::pmap_dbl( .l = list( .ps = ps , .q = est.quants, .obs = Testdata),
.f = function(.ps, .q, .obs){
if(is.null(.obs)){ NA} else{
compute_qs(obs = unlist(.obs) , quant.est = .q,
p = .ps) }
})) %>%
dplyr::arrange(ps, ds)
return(table_quants)
}
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  dur,
quants = .99)  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
tibres
tibres %>% unnest(cols = Result)
tibres %>% unnest(cols = Result) %>% tail()
tibres[1, ]$left_out
' dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2000, 2001, 2002),
#'  quants = c(.5, .9, .99) )
' dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2000, 2001, 2002),
quants = c(.5, .9, .99) )
' dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2000, 2001, 2002),
quants = c(.5, .9, .99) )
dgev_cv_fit(agbm, concbm, ds = c(1,2) , leave_out = c(2000, 2001, 2002),
quants = c(.5, .9, .99) )
#' example_data <- data.frame(datetime = dates, prec = prec)
#'
#' agbm <- get_agg_bm(example_data, ds = c(1,2,4,8,16, 24, 48))
#' agdf <- fun_aggregate2df( example_data, ds = c(1,2,4,8,16, 24, 48) )
#' concbm <- compute_conc_bm_id(agdf, testset = "consec")
#' cvres <- fit_dgev_cv_qs(agbm, concbm,  ds = c(1,4,8, 24))
#' # compute mean quantile scores based on cross-validation:
#' cvres %>% dplyr::select( - c( mut, sigma0, shape, eta, conv, Testdata )) %>%
#'           dplyr::group_by(ds, ps, estimator) %>%
#'           dplyr::summarise(MQS = mean(quant_score), .groups = "drop")
fit_dgev_cv_qs <- function(agg_bm, conc_bm, ds,
quants =  1-1/c(50, 100 ), mult_sc = FALSE,
dur_offset = FALSE, int_offset = FALSE, testset = "consec",
n.lo = 3, n.cv = NULL, method = "both", returnLO = FALSE,
optimMethod = "Nelder-Mead", Maxit = 1500, ... ){
years_obs <- agg_bm[1, ]$djbm[[1]]$Year
n.years <- length(years_obs)
if(testset == "consec") {
cvstart <- seq(years_obs[1], years_obs[n.years], n.lo)
sbst <- purrr::map(cvstart, ~ .x + (0:(n.lo -1)))
sbst[[length(sbst)]] <-  sbst[[length(sbst)]][ sbst[[length(sbst)]] <= years_obs[n.years]]
sbst <- sbst[map(sbst, ~ length(.x)) == n.lo]
n.cv <- length(sbst)
} else if( testset == "random") {
assertthat::assert_that(is.numeric(n.cv))
all.subsets <- combn(years_obs, n.lo, simplify = F)
sbst <- sample(all.subsets, min(n.cv, nrow(all.subsets)) )
n.cv <- length(sbst)
} else {
stop("This is not a valid method to construct the test set. Choose either 'consec' or 'random'")
}
tibres <- tibble::tibble(left_out = sbst)  %>%
dplyr::mutate( Result = purrr::map( left_out, .f = function(.x){
tryCatch(
dgev_cv_fit(agg_bm = agg_bm, conc_bm = conc_bm, leave_out = .x, ds =  ds,
quants = quants, mult_sc = mult_sc, dur_offset = dur_offset,
int_offset = int_offset, optimMethod = optimMethod, Maxit = Maxit, ... )  ,
error = function(egal){
tibble::tibble( mut = NA, sigma0 = NA, shape = NA,
eta = NA,
estimator = NA,  ps = NA, ds  = NA,
est.quants = NA, Testdata = NA, quant_score = NA)
} )
}))
if(!returnLO){
tibres <-   tibres %>% dplyr::select(-left_out)
}
if(!(method == "both")){
tibres <- tibres %>%
dplyr::mutate( Result = purrr::map(Result, ~ .x %>% dplyr::filter( estimator == method)))
}
tibres %>% tidyr::unnest(cols = Result)
}
cvres <- fit_dgev_cv_qs(agbm, concbm,  ds = c(1,4,8, 24))
cvres
cvres %>% tail()
cvres %>% dplyr::select( - c( mut, sigma0, shape, eta, conv, Testdata )) %>%
dplyr::group_by(ds, ps, estimator) %>%
dplyr::summarise(MQS = mean(quant_score), .groups = "drop")
agdf <- fun_aggregate2df(data = precEssen, ds = dur, seasonlength = 92)
agbm <- get_agg_bm(data = precEssen, ds = dur, seasonlength = 92)
concbm <- compute_conc_bm_id(agdf, seasonlength = 92, testset = "consec")
cv_res <- fit_dgev_cv_qs(agg_bm = agbm, conc_bm = concbm, ds = dur,
quants = c(0.5, 0.8, 0.9, 0.95, 0.99, 0.995),
mult_sc = TRUE)
meanQS <-  cv_res %>% dplyr::select( - c( mut, sigma0, shape, eta, conv, Testdata )) %>%
dplyr::group_by(ds, ps, estimator) %>%
dplyr::summarise(MQS = mean(quant_score), .groups = "drop")
meanQS
QSI <- meanQS %>% pivot_wider( names_from = estimator, values_from = MQS) %>%
mutate( QSI = purrr::map2_dbl( .x = disjoint, .y = sliding, ~ compute_qsi(.y, .x)))
devtools::build_vignettes()
devtools::build_vignettes()
install.packages("lintr")
lintr::lint_package()
